说明书摘要	
本发明属于软件安全技术领域，公开了一种基于大语言模型引导的恶意样本加密流程追踪方法。该方法通过静态分析技术提取二进制恶意样本中的潜在加密特征，并识别其相关的函数调用关系。接着，利用大语言模型（LLM）强大的语义理解和推理能力，对反汇编的代码进行自动化筛选与推理，剔除无关的执行路径，从中筛选出与密钥生成和加密操作相关的关键函数子集。随后，将筛选出的函数子集作为输入，交由angr符号执行框架进行进一步分析，通过对关键函数参数的标记，开展动态污点分析和路径探索，精确识别加密流程中的重要环节。最终，本发明实现了对恶意样本加密全过程的自动化识别，并能够准确定位加密密钥与敏感数据存储位置。本发明有效解决了传统符号执行方法中的“路径爆炸”问题，显著提高了针对复杂加密类对抗行为的分析效率。
摘要附图	


图 1 























权利要求书	
1.一种基于大语言模型引导的恶意样本加密流程追踪方法，其特征在于，所述方法包括以下步骤：S1.候选特征提取：对二进制恶意样本进行静态扫描，提取加密算法相关的静态特征，包括加密常量、S-Box查找表及API调用信息，并基于所述静态特征识别候选加密函数；S2.静态数据流与语义筛选：对所述候选加密函数进行基于中间语言（IL）的静态数据流分析，构建函数内部及跨函数的变量传递路径；同时利用大语言模型对函数的反汇编代码及数据流上下文进行语义推理，筛选出涉及密钥处理与核心加密操作的目标函数子集，生成引导蓝图；S3.引导式动态符号执行：基于所述引导蓝图，利用符号执行引擎对所述目标函数进行动态分析；通过在引导地址处主动触发检测、限制循环展开次数及基于评分机制裁剪低价值状态，缓解路径爆炸问题；同时在符号执行过程中监控内存读写操作，提取加密密钥及确认数据流向；S4.攻击链综合研判：综合S1的静态特征、S2的语义筛选结果及S3的动态执行证据，通过多层交叉验证确定加密算法类型，并基于数据流连通性构建恶意行为攻击链。
2.根据权利要求1所述的方法，其特征在于，在步骤S1中，所述加密常量的提取包括识别单值常量及连续的S-Box/T-Table查找表；所述识别过程通过匹配预定义的加密算法特征库实现，所述特征库包含AES、TEA、RC4、ChaCha20等常见加密算法的常量签名及表结构特征；对于识别到的S-Box/T-Table，进一步通过交叉引用分析关联至引用该表的函数。
3.根据权利要求1所述的方法，其特征在于，在步骤S2中，所述静态数据流分析基于静态单赋值（SSA）形式的中间语言进行，包括： 构建函数内部的Def-Use链，追踪变量的定义与使用关系； 通过分析内存存储（STORE）与加载（LOAD）指令的地址表达式，建立非栈内存的数据流传播路径； 沿函数调用图（Call Graph）向上追溯调用者（Caller），并根据调用者的交叉引用数量进行优先级排序，优先分析业务逻辑紧密的调用路径； 生成的引导蓝图包含目标函数地址、关键执行路径节点、污点源（Source）与汇聚点（Sink）信息。
4.根据权利要求1所述的方法，其特征在于，在步骤S2中，所述利用大语言模型进行语义推理具体包括： 构建包含函数反汇编代码片段、数据流证据（Source/Sink API类别）及初步算法识别结果的提示词（Prompt）； 将所述提示词输入大语言模型，要求模型输出加密算法类型及恶意行为场景分类的判定结果； 所述恶意行为场景分类至少包括载荷解密加载（Payload Decryption Loading）、C2命令执行（C2 Command Execution）、数据窃取（Data Exfiltration）及勒索加密（Ransomware Encryption）。
5.根据权利要求1所述的方法，其特征在于，在步骤S3中，所述引导式动态符号执行具体包括： 初始化符号执行状态，对目标函数的输入参数注入符号化污点； 在符号执行过程中，实时检查当前执行状态的指令地址是否命中引导蓝图中的关键路径节点；若命中，则对当前状态进行全量Sink检测并给予高优先级评分； 通过LoopSeer机制限制循环结构的符号执行次数，并统计基本块的访问频率，当访问频率超过预设阈值时强制终止当前路径的探索； 基于状态评分机制动态裁剪活跃状态集，所述评分机制根据是否命中API、是否在引导路径上、以及路径探索的新颖性对状态进行加权。
6.根据权利要求1所述的方法，其特征在于，在步骤S3中，所述提取加密密钥具体包括： 在符号执行过程中注册内存写入（Memory Write）监控钩子； 当检测到内存写入操作时，捕获写入的数据内容及目标地址； 对写入的数据内容进行熵值计算及字符分布分析，若数据长度、熵值及字符分布符合密钥特征，且写入位置邻近密钥管理API调用点，则将其标记为候选密钥。
7.根据权利要求1所述的方法，其特征在于，在步骤S4中，所述多层交叉验证确定加密算法类型具体包括： Layer-A：基于步骤S1提取的YARA规则命中、S-Box匹配及常量特征进行第一层投票； Layer-B：基于步骤S2提取的指令操作码直方图（Opcode Histogram）及SSA数据流特征进行第二层投票；所述操作码直方图统计XOR、SHIFT、ROTATE等指令的分布比例，并与预置的加密算法指纹模板进行匹配； Layer-C：基于步骤S3动态执行过程中检测到的运行时常量及S-Box访问行为进行第三层投票； 对上述三层投票结果进行加权汇总，判定最终的加密算法类型及置信度。
8.根据权利要求1所述的方法，其特征在于，在步骤S4中，所述构建恶意行为攻击链具体包括： 定义攻击链的三段式结构为：污点源（Source）→加密操作（Crypto）→汇聚点（Sink）； 检查步骤S3的动态执行路径中，是否存在从污点源API到加密函数，再到汇聚点API的完整数据流连通性； 若存在完整连通性，则标记该攻击链为已验证（Verified），并根据污点源与汇聚点的API类别组合，将攻击行为归类为具体的恶意场景。
9.一种基于大语言模型引导的恶意样本加密流程追踪系统，其特征在于，包括： 静态特征提取模块，用于执行步骤S1，提取加密特征并识别候选函数； 语义分析与蓝图生成模块，用于执行步骤S2，结合SSA数据流分析与大语言模型推理生成引导蓝图； 动态符号执行模块，用于执行步骤S3，基于引导蓝图进行路径探索与密钥提取； 综合研判模块，用于执行步骤S4，输出加密算法类型及恶意行为攻击链报告。
10.一种计算机可读存储介质，其上存储有计算机程序，其特征在于，所述计算机程序被处理器执行时实现如权利要求1至8中任一项所述的方法。
说明书	

基于大语言模型引导的恶意样本加密流程追踪方法

技术领域
本发明属于软件安全技术领域，具体涉及二进制程序分析、恶意代码检测以及大语言模型（LLM）在自动化逆向工程中的应用，尤其涉及一种利用大语言模型引导符号执行以识别恶意样本加密流程的方法。
背景技术
随着恶意代码对抗技术的演进，越来越多的恶意软件（如勒索软件、窃密木马等）采用高强度加密算法来保护其关键指令、配置信息及通信数据，以规避杀毒软件的静态扫描与特征检测，目前的分析手段主要面临以下挑战：一是传统的人工逆向分析高度依赖分析师经验，在面对海量恶意样本变种时效率低下，难以实现自动化处理；二是利用符号执行等工具进行自动化分析时，二进制程序内复杂的条件分支会导致执行路径呈指数级增长，极易引发“路径爆炸”问题，导致计算资源枯竭且难以触达核心加密逻辑；三是传统的自动化分析工具缺乏对反汇编代码宏观语义的理解，难以在缺乏源码的情况下直接还原出复杂的加密逻辑和算法意图。因此，如何结合人工智能技术提升恶意样本加密全流程的自动化追踪与识别能力，已成为当前网络安全领域亟待解决的关键问题。
发明内容
本发明目的在于提供一种基于大语言模型引导的恶意样本加密流程追踪方法，实现对恶意样本加密对抗行为的自动化识别与密钥提取 。以解决传统符号执行分析恶意样本时因执行路径过于庞大而导致的“路径爆炸”以及人工逆向效率低下的问题。
为实现上述目的，本发明的具体技术方案如下：
一种基于大语言模型引导的恶意样本加密流程追踪方法，该方法融合了静态特征匹配、大语言模型语义推理与动态符号执行技术。首先利用静态分析提取二进制样本中的加密特征并定位候选函数；随后利用大语言模型（LLM）的语义理解能力对候选函数的汇编代码或中间语言进行分析，剔除无关路径并生成引导蓝图；接着将引导蓝图作为约束条件输入符号执行引擎，进行受控的动态路径探索与污点分析；最终实现对恶意样本加密全流程的自动化识别，并精准定位加密密钥与敏感数据流向。
进一步，所述恶意样本加密流程追踪方法，共分为四个步骤：
第一步：静态特征提取与关联定位
本发明首先利用Yara等特征匹配工具对收集到的二进制恶意样本进行多维度扫描，以识别样本中潜在的加密逻辑。具体而言，本发明预先构建了包含多种公开加解密算法特征的规则库，特征包括但不限于对称加密算法（如AES、DES）中的S盒常量、分组密码的轮常数、非对称加密算法（如RSA）中的大质数指纹以及特定的移位异或循环结构。在通过特征匹配精确定位到特征所在的内存偏移地址后，需要结合反汇编技术进一步分析函数间的逻辑关联，主要包含以下两步：
（1）基于脚本的候选函数定位： 利用在反汇编工具中定制开发的自动化分析脚本，以识别出的特征地址为起始点，通过控制流图（CFG）进行向上溯源。脚本自动分析函数的调用栈与交叉引用（Xref）关系，定位所有直接或间接调用该特征地址的函数作为“候选加密函数”。该过程通过递归搜索，能够识别出样本中负责密钥扩展、初始置换等关键行为的顶层函数，从而初步圈定恶意样本中潜在的加密逻辑边界。
（2）指令序列追踪与拓扑构建： 在定位到候选加密函数后，定制脚本向下追踪受特征数据影响的指令序列，记录数据流经的寄存器及内存单元。通过提取候选函数内部的反汇编逻辑，本发明将原本离散的汇编指令转化为包含函数依赖、调用次序的拓扑调用关系图。该关系图能够清晰展示样本内部加密对抗功能的执行链路，提取出的反汇编代码片段将作为后续步骤中大语言模型语义分析的基础数据输入。
静态特征提取与关联定位的流程如图2所示。

图 2 静态特征提取与关联定位的流程图
第二步：大语言模型引导的路径筛选
本发明将第一步提取的候选函数代码逻辑封装入预设的提示词（Prompt）模板，输入至大语言模型中进行语义识别。为了确保筛选的严谨性，本发明利用大模型对复杂的控制流进行剪枝，剔除与加密流程无关的错误检查分支、日志记录逻辑或死代码。通过大语言模型的语义推理，本发明显著缩减了后续动态分析的搜索空间，从根本上规避了符号执行引擎盲目探索导致的路径爆炸问题。
具体实现包含以下两步： 
（1）面向语义识别的提示词（Prompt）构造：本发明构建了专门针对二进制逆向场景的提示词模板，将反汇编逻辑结构化。模板由三部分组成：一是上下文背景信息，告知大语言模型当前分析的任务目标（识别加密逻辑）；二是代码片段载体，将第一步获取的中间语言代码按基本块进行封装；三是分析任务指令，明确要求模型识别出：① 函数是否包含核心加密运算逻辑（如密钥调度、异或变换）；② 识别该函数的行为意图（如载荷解密、C2通信）；③ 标记出关键参数的存储位置（如密钥指针、密文缓冲区）。 
（2）基于语义推理的引导蓝图生成：根据大语言模型返回的分析结果，系统生成结构化的“引导蓝图（Blueprint）”。该蓝图包含确定的目标函数地址、符号执行应当优先探索的“关键基本块路径”以及建议的污点源（Source）注入位置。该蓝图将作为后续步骤中符号执行引擎的硬约束条件，强制引擎仅关注有效路径。 大语言模型引导的路径筛选与蓝图构建流程如图3所示。

图 3 大语言模型引导路径筛选的流程图
第三步：引导式符号执行与密钥精准提取
本发明接收第二步输出的引导蓝图，将其注入Angr等符号执行引擎中。通过结合大语言模型提供的语义引导，本发明显著降低了分析复杂程序时的路径探索深度，能够高效地触达核心加密逻辑。
具体实现包含以下两步： 
（1）引导式路径探索与状态裁剪：本发明首先根据蓝图设置符号执行的起始点，并将目标函数的关键参数标记为符号化变量（污点源）。在路径探索过程中，采用LoopSeer机制限制循环结构的迭代次数，防止引擎陷入加密算法特有的复杂循环（如RC4的256次初始化循环）；同时引入动态评分机制，对命中蓝图引导地址的执行状态给予高优先级，对偏离引导路径的状态进行快速剪枝，从而将计算资源集中在核心逻辑上。 
（2）基于熵值的密钥动态提取：在符号执行过程中，本发明注册了内存写入（Memory Write）监控钩子。当程序在加密函数上下文中执行写操作时，实时捕获写入的数据内容并计算其香农熵（Shannon Entropy）。若写入数据的长度符合密钥特征（如16字节或32字节）且熵值超过预设阈值（如3.5），则判定该数据为解密密钥或轮密钥，并记录其内存地址。该方法无需了解具体的密钥生成算法细节，即可在动态模拟中捕获生成的密钥。 引导式符号执行与密钥精准提取的流程如图4所示。

图4 引导式符号执行与密钥精准提取流程图
本发明的引导式符号执行与密钥提取方法主要分为以下几步：
（1）基于引导蓝图的状态初始化与污点注入 对步骤二生成的大语言模型引导蓝图进行解析，了解目标函数的参数结构及关键路径节点。蓝图记录了目标函数在二进制文件中的虚拟地址、关键基本块列表以及建议的污点注入位置。为了在符号执行过程中追踪数据流向，需要根据蓝图信息初始化符号执行引擎的状态，并注入符号化变量。 状态初始化包含三个步骤。首先，加载二进制文件并创建符号执行工程（Project），将执行起始点设置为蓝图中指定的目标函数入口地址；其次，配置符号执行的内存模型，启用延迟求解（Lazy Solves）策略以优化性能，并根据蓝图中的建议，将目标函数的输入参数（如密文缓冲区指针、数据长度）替换为符号化向量（BVS），而非具体的数值；最后，初始化污点传播上下文，将符号化变量标记为污点源（Source），以便后续追踪其在寄存器和内存中的传播路径。
（2）启发式路径探索与循环控制 根据引导蓝图中的关键路径节点，对符号执行过程中的活跃状态进行筛选和剪枝，并在复杂控制流中进行受控探索。使用启发式算法，对符号执行引擎产生的状态机（SimGr）进行深入管理。状态机展示了程序所有可能的执行分支，通过分析当前状态的指令地址，可以识别出该状态是否命中了大语言模型预测的加密逻辑路径。 路径探索与控制主要包含两方面机制。一方面，引入LoopSeer循环控制机制，实时监测执行流中的循环结构，当检测到加密算法特有的紧密循环（如RC4的256次初始化循环）时，强制限制其展开次数（例如限制为8次），防止符号执行陷入无限循环；另一方面，实施基于评分的状态剪枝，定义状态评分函数，对命中引导蓝图地址的状态给予高分（如+40分），对命中API入口的状态给予奖励（+50分），而对陷入死循环的状态扣分（-50分），每步执行后仅保留评分最高的若干状态（如Top-12），从而有效规避路径爆炸问题。
（3）基于内存监控的动态密钥捕获 在符号执行引擎中注册内存监控钩子（Hook），实时捕获程序运行时的数据写入行为，从而提取潜在的解密密钥。这一步的核心在于利用加密算法密钥扩展（Key Schedule）过程产生高熵值数据的特征。 密钥捕获的具体操作如下：首先，在符号执行引擎的内存写入事件（mem_write）上设置断点；当程序执行到任何内存写入指令时，暂停执行并提取即将写入内存的数据内容及目标地址；接着，对捕获的数据进行香农熵（Shannon Entropy）计算。加密密钥通常具有极高的随机性，其熵值会显著高于普通程序数据（如字符串或指针）。 系统设定判定阈值（例如熵值>3.5且长度为16或32字节）。若捕获的数据满足该阈值条件，且写入操作发生在加密函数的执行上下文中，则将其判定为解密密钥并记录。该操作在保证不依赖特定算法逆向代码的同时，通过监控通用的内存行为，成功捕获了动态生成的密钥数据。捕获完成后，符号执行继续进行，以验证该密钥关联的数据流是否最终流入敏感API（Sink）。密钥提取与流向验证的原理如图5所示。
图5 密钥提取与流向验证的流程图
第四步：多源证据融合与攻击链综合研判 
本发明根据第三步获取的动态分析结果，结合前两步的静态证据，识别恶意样本的加密对抗行为模式。通过整合静态特征、语义分析结论与动态污点追踪路径，本发明能够精准还原恶意代码的数据流转逻辑，生成高置信度的分析报告。
具体实现包含以下两步： 
（1）算法多层交叉验证：汇总是静态特征扫描（YARA/S-Box）、静态代码指纹分析（Opcode Histogram）以及动态运行时常量检测的结果，通过加权投票机制确定最终的加密算法类型，解决了单一检测手段误报率高的问题。 
（2）攻击链闭环验证：检查符号执行的路径记录（Trace），验证是否存在从“污点源（Source，如网络接收API）”经过“加密操作（Crypto函数）”最终到达“敏感操作（Sink，如内存执行API）”的完整数据流连通性。只有数据流闭环连通的路径才被确认为有效的恶意攻击链，从而生成包含恶意行为类型、置信度、加密算法及提取密钥的最终分析报告。加密全流程识别与结果产出的流程如图6所示。 

图6 加密全流程识别与结果产出流程图
本发明还提供了具体的技术特征说明，以方便理解以及对权利要求进行限定。本发明提出一种基于大语言模型引导的恶意样本加密流程追踪方法，其特征在于可以实现对恶意样本加密对抗行为的自动化识别、攻击链闭环验证及密钥精准提取。本发明方法共有四个步骤。步骤一，静态特征提取与关联定位，利用YARA规则及预置的加密常量库对二进制样本进行全量扫描，识别S-Box等静态特征，并结合反汇编工具的交叉引用技术，向上回溯定位引用这些特征的候选加密函数。步骤二，大语言模型引导的路径筛选与蓝图构建，提取候选函数的中间语言（MLIL）代码片段及控制流信息，利用大语言模型的语义推理能力剔除与加密无关的冗余路径（如错误检查、日志记录），生成包含关键节点地址和污点注入位置的引导蓝图。步骤三，引导式符号执行与密钥精准提取，将引导蓝图作为约束条件注入符号执行引擎，通过LoopSeer机制限制循环迭代次数以规避路径爆炸，同时在执行过程中利用内存写入监控与熵值分析技术，实时捕获并提取高熵值的解密密钥。步骤四，多源证据融合与攻击链综合研判，综合静态特征、语义分析与动态执行结果进行加密算法的三层交叉验证，并基于数据流连通性验证“源-算法-汇聚点”的完整攻击链，生成包含恶意行为类型、置信度及密钥信息的最终分析报告。
本发明具有以下优点：
（1）解决符号执行的路径爆炸难题：本发明引入大语言模型作为智能辅助，通过语义理解对二进制函数的控制流进行预筛选和剪枝。生成的引导蓝图强制符号执行引擎仅关注核心加密逻辑路径，有效避免了引擎在处理混淆代码或复杂分支时产生的状态空间指数级膨胀，显著提升了分析效率。
（2）实现无源码环境下的自动化密钥提取：本发明创新性地结合了动态内存监控与数据熵值分析技术。在符号执行过程中，实时计算内存写入数据的香农熵，能够在不依赖特定解密算法逆向代码且无源代码的情况下，通用于多种对称加密算法（如AES、RC4等）的密钥提取，大大降低了人工逆向分析的成本。
（3）高置信度的恶意行为研判：不同于传统基于签名的静态检测，本发明通过构建完整的“数据源（Source）→加密操作（Crypto）→敏感行为（Sink）”数据流攻击链来判定恶意行为。只有当动态污点分析证明数据流闭环连通时才确认恶意行为成立，这种基于数学逻辑的验证方式提供了强有力的证据，有效降低了误报率。
附图说明
图1为本发明的方案流程图；
图2为本发明的特征提取流程图；
图3为本发明的二进制重写方法流程图；
图4为本发明的指令替换与修改示意图；
图5为本发明的指令重构示意图。
具体实施方式
为了更好地了解本发明的目的、技术方案及功能，下面结合附图，对本发明做进一步详细的描述，但是本发明可以根据权利要求限定和覆盖的多种不同方式实施。构成本申请的一部分的附图用来提供对本发明的进一步理解，本发明的示意性实施例及其说明用于解释本发明，并不构成对本发明的不当限定。
如图1所示，本发明的方法流程图。
核心发明点：
(1) 基于静态特征与交叉引用的候选函数定位
本发明利用预先构建的加密算法特征规则库（YARA规则、S-Box等），对二进制样本进行全方位的静态扫描。通过识别样本中硬编码的加密常量和查找表，并结合反汇编工具的交叉引用分析技术，快速定位引用这些特征的代码位置，从而筛选出可能包含加密逻辑的候选函数。这一过程能够在分析初期排除大量无关代码，显著提高后续分析的针对性。
(2) 基于LLM语义理解的路径剪枝与蓝图构建
本发明创造性地引入大语言模型（LLM）作为逆向分析的辅助智能体。通过提取候选函数的中间语言（MLIL）代码片段及相关控制流信息，构建特定的提示词（Prompt）引导LLM进行语义推理。LLM能够识别函数的行为意图（如解密、通信），并判断代码块的重要性。系统根据LLM的反馈生成“引导蓝图”，该蓝图明确指出了符号执行应当关注的关键路径节点，从而剔除死代码和无关逻辑，有效规避了传统符号执行中的路径爆炸问题。
(3) 引导式动态符号执行与密钥精准提取
本发明提出了一种受控的动态符号执行方法。将“引导蓝图”作为硬约束注入符号执行引擎（如Angr），限制引擎仅在预定路径上探索。同时，通过引入LoopSeer机制动态限制循环迭代次数，并采用Lazy Solves策略优化约束求解效率。更重要的是，本发明在符号执行过程中植入了内存写入监控钩子，实时捕获并分析内存数据的熵值，从而在不完全运行恶意代码的情况下，精准提取出解密密钥。
(4) 多源证据融合的攻击链综合研判
本发明构建了一个多层次的证据融合框架。它综合了静态扫描的特征指纹、静态数据流分析的源/汇聚点信息，以及动态符号执行的路径验证结果。通过三层交叉验证机制（Layer-A/B/C）来确认加密算法的类型，并基于数据流的连通性重构出完整的“Source（源）-Crypto（算法）-Sink（汇聚点）”攻击链，最终生成包含恶意行为判定、置信度评估及关键参数的高质量分析报告。
核心发明点细节：
(1) 基于静态特征与交叉引用的候选函数定位
本发明预置了涵盖AES、DES、RC4、ChaCha20等主流加密算法的特征库。具体操作包括：
A. 特征扫描：遍历二进制文件的只读数据段（.rdata）和数据段（.data），匹配加密算法特有的S-Box（替换表）、T-Table或初始化向量（IV）。
B. 引用回溯：一旦特征被匹配，立即通过反汇编引擎查询该地址的交叉引用（Xrefs）。系统追踪所有引用该特征地址的指令，向上回溯至所属函数，并将这些函数标记为“候选加密函数”，同时记录其入口地址和物理偏移。
(2) 基于LLM语义理解的路径剪枝与蓝图构建
本步骤主要由混合分析引擎（HybridSemanticAnalyzer）执行，细节如下：
A. 静态污点预分析：基于二进制中间语言（MLIL）的SSA（静态单赋值）形式，构建函数内部的Def-Use链。系统自动识别函数内的潜在输入源（Source，如recv、ReadFile）和潜在汇聚点（Sink，如VirtualAlloc、WriteFile）。
B. 提示词工程与推理：构建包含函数控制流摘要、关键API调用列表及核心MLIL代码片段的Prompt。Prompt设计旨在引导LLM忽略日志记录、错误检查等辅助性代码，专注于识别与密钥编排（Key Schedule）和数据变换相关的核心逻辑。
C. 蓝图生成：根据LLM输出的语义分析结果，系统生成JSON格式的“引导蓝图”。蓝图中详细标记了符号执行应优先探索的“关键基本块地址”以及建议的“污点注入位置”。
(3) 引导式动态符号执行与密钥精准提取
本步骤在WorkerEngine中实现，细节如下：
A. 环境配置与污点注入：加载二进制文件，根据蓝图设置符号执行的起始状态。将目标函数的关键输入参数（如密文缓冲区指针）替换为符号变量（Symbolic Variable），而非具体数值。
B. 启发式状态管理：引入动态评分机制，对当前的执行状态进行打分。命中蓝图引导地址的状态获得加分，陷入无效循环或偏离引导路径的状态被减分，系统据此动态剔除低价值路径，集中资源探索核心逻辑。
C. 密钥提取Hook：在符号执行引擎中注册内存写入断点。当检测到程序在加密函数上下文中进行内存写入时，捕获写入的数据内容，计算其香农熵（Shannon Entropy）。若数据长度符合密钥特征（如16字节或32字节）且熵值较高（>3.5），则判定为潜在密钥并予以记录。
(4) 多源证据融合的攻击链综合研判
本步骤由行为合成器（BehaviorSynthesizer）完成，细节如下：
A. 算法投票：汇总是静态YARA匹配、静态代码指纹分析（Opcode Histogram）、动态运行时常量检测的结果，进行加权投票。例如，静态特征权重较高，动态验证作为确认，最终确定加密算法类型。
B. 攻击链重构：检查符号执行的路径记录（Trace），确认是否存在从Source API（如recv）到Crypto函数，再到Sink API（如WinExec）的完整数据通路。只有数据流连通的路径才会被标记为“已验证（Verified）”，从而构建出完整的恶意行为攻击链。
核心发明点原理：
(1) 静态特征提取原理
加密算法为了保证混淆与扩散效果，通常依赖特定的数学常数或查找表（S-Box）。这些常量在编译后的二进制文件中通常以连续字节序列的形式存在，且在不同版本的代码中保持稳定。通过匹配这些独一无二的“指纹”，可以快速缩小逆向分析的范围，精准定位到核心算法代码段。
(2) 路径剪枝与LLM引导原理
符号执行面临的最大挑战是路径爆炸，即程序分支数量随深度呈指数级增长。大语言模型（LLM）具备对汇编代码语义的高级理解能力，能够像经验丰富的逆向工程师一样，快速判断哪些分支是实现加密逻辑的“主干”，哪些是错误处理或无关功能的“枝叶”。利用LLM的判断结果作为“路标”来约束符号执行引擎的搜索空间，可以将计算资源集中在有效路径上，从而在有限时间内完成对复杂函数的分析。
(3) 密钥提取原理
加密程序的密钥扩展（Key Schedule）过程通常涉及将原始密钥经过复杂的数学变换后写入内存缓冲区，以生成轮密钥。这一过程产生的数据具有极高的随机性，表现为高熵值。符号执行引擎能够精确模拟CPU指令的执行。通过监控内存写入操作并计算数据的熵值，可以在密钥生成的瞬间将其捕获。这种方法不依赖于特定的密钥生成算法细节，具有很强的通用性。
(4) 攻击链验证原理
恶意行为（如勒索加密、C2回连）在底层表现为数据的特定流向。例如，勒索软件的行为模式是：ReadFile（读取文件） -> Encrypt（加密） -> WriteFile（写入文件）。通过污点分析（Taint Analysis），如果能证明WriteFile写入的数据直接派生自ReadFile读取的数据且经过了加密函数处理，则可以在数学上严格证明该恶意行为的存在，从而排除巧合或误报。
细节问题：
本发明相较于现有技术，显著提高了对复杂、混淆恶意样本的分析成功率，并且能够在不运行样本的静态或半静态环境下，精准提取解密密钥，具有更高的安全性和效率。
实施例1
本实施例以一个典型的恶意软件加载器样本（SHA256: 0000de7eb061559767e4f9d5f545cff203c2a77f149fade7812c8c467eaa31c1）为例，演示本发明方法的具体执行过程。该样本使用了代码混淆技术，且加密函数经过了自定义修改，传统静态分析难以直接识别。
1、静态特征提取与关联定位（Step 1）
系统首先启动静态扫描模块（对应代码 crypto_discovery.py）。
特征扫描：系统加载预置的YARA规则库对样本二进制文件进行全量扫描。扫描结果显示，在文件的只读数据段（.rdata）偏移 0x403020 处并未发现标准的AES S-Box，但发现了一段疑似高熵值的连续数据，且未命中任何标准加密常数。
交叉引用回溯：尽管未命中强特征，系统通过反汇编引擎（BinaryNinja）的API分析，发现该高熵值数据被函数 sub_4021f3 引用。系统进一步分析该函数的指令直方图，发现异或（XOR）指令占比高达 15%，且包含双重循环结构。
候选确定：基于上述特征，系统将 sub_4021f3 标记为“高优先级的候选加密函数”，并将其物理地址映射为虚拟地址，存入候选列表。
(图注：图7 - 静态特征提取与候选函数定位。图中展示了高熵数据块及其被函数 sub_4021f3 引用的交叉关系。)
如图2所示，为静态特征提取后的候选函数定位示意图。
2、大语言模型引导的路径筛选（Step 2）
系统启动混合分析模块（对应代码 hybrid_analysis.py）。
中间语言提取：系统提取 sub_4021f3 的 MLIL（中级中间语言）代码片段。由于函数内包含大量混淆用的垃圾指令（如无效的算术运算），直接阅读非常困难。
语义推理：系统构建提示词（Prompt），将函数的控制流图摘要、关键API调用（该函数内部未调用API）及MLIL代码发送给大语言模型。
Prompt内容示例：“分析以下汇编逻辑，识别其是否为加密函数。如果是，指出密钥参数和密文参数的位置。”
LLM反馈与蓝图生成：大语言模型返回分析结果：“该函数具有典型的流密码特征，结构类似于RC4的KSA（密钥调度）和PRGA（伪随机生成）阶段。参数1推测为密钥缓冲区，参数2为数据长度。”
蓝图输出：系统据此生成“引导蓝图（Blueprint）”，标记了函数入口 0x4021f3，并建议将 arg1 标记为污点源进行追踪，同时指出了循环体的入口地址作为关键路径节点。
如图8所示，为LLM引导的路径筛选与蓝图生成过程。
3、引导式符号执行与密钥提取（Step 3）
系统启动动态分析模块（对应代码 symbolic_execution.py），加载步骤2生成的蓝图，利用Angr框架进行引导式符号执行。
环境初始化：系统将符号执行的起始点设置为 0x4021f3。根据蓝图，系统构建了一个符号化的内存区域作为“密钥”，并将指向该区域的指针传递给函数参数。
抗路径爆炸处理：
LoopSeer机制：RC4算法包含一个256次的初始化循环。系统监测到循环计数器在不断增加，自动触发 LoopSeer 机制，强制将循环展开次数限制为 8 次。这使得符号执行引擎在几秒钟内跳出了原本需要数分钟才能跑完的循环，成功规避了路径爆炸。
状态裁剪：执行过程中产生了约 40 个分支状态。系统利用评分函数 _prune_states，对命中蓝图关键节点的状态给予 +40 分，对陷入死循环的状态给予 -50 分，动态剔除了 30 个低价值状态，仅保留 10 个核心状态继续探索。
密钥精准提取：
在执行过程中，内存监控钩子（Memory Write Hook）捕获到程序在地址 0x4021f3 执行期间，向栈空间写入了一段 16 字节的数据。
熵值校验：系统即时计算该数据的香农熵，结果为 3.85（接近最大值 4.0）。
提取结果：系统判定该数据为解密密钥，内容为 1F 2B 3C 4D ...。
污点流向验证：符号执行继续运行，追踪到函数返回后的数据流。系统发现，经 sub_4021f3 处理后的数据（即解密后的Payload），被直接作为参数传递给了 VirtualAlloc 申请的具有 PAGE_EXECUTE_READWRITE 属性的内存区域，随后程序跳转（jmp）到该区域执行。


如图9所示，为符号执行过程中的密钥提取与路径探索。
4、加密全流程识别与结果产出（Step 4）
系统启动综合研判模块（对应代码 step4_behavior_synthesis.py），对上述证据进行融合。
算法判定：虽然静态特征未明确命中RC4，但Step 2的LLM分析（Opcode指纹）和Step 3的动态行为（256次循环结构、异或操作）均强指向RC4算法。三层交叉验证系统判定算法为 RC4。
攻击链重构：系统检测到完整的数据流路径： Resource段数据 (Source) -> sub_4021f3 (Crypto: RC4) -> VirtualAlloc (Sink) -> Execution。 由于数据流完全连通，系统将该攻击链标记为 Verified（已验证）。
最终报告：系统生成JSON报告，明确指出：
恶意行为：Payload_Decryption_Loading（载荷解密加载）。
加密算法：RC4。
解密密钥：1F 2B 3C 4D ...（Hex），位于内存偏移 0x12ff80。
置信度：95/100。


(图注：图10 - 加密全流程识别结果。展示了从加密数据源到恶意行为执行的完整攻击链拓扑图。)
通过本实施例可以看出，本发明能够在无源码、代码混淆的情况下，高效精准的完成了对恶意样本加密逻辑的定位、密钥提取及行为意图识别，验证了方法的高效性与准确性。
本发明的优点：
(1) 解决路径爆炸难题：通过大语言模型的语义理解能力进行预筛选和路径引导，使得符号执行引擎无需盲目探索所有分支，从而能够处理逻辑复杂的恶意样本，显著提升了分析效率和成功率。
(2) 自动化密钥提取：结合动态内存监控与熵值分析，能够在不依赖特定解密算法逆向代码的情况下，通用于多种对称加密算法的密钥提取，大大降低了人工分析成本。
(3) 高置信度的行为研判：不同于传统的基于签名的检测，本发明基于完整的数据流连通性（从Source到Sink）来判定恶意行为，提供了数学层面的证据，极大地降低了误报率。
以上所述仅是本发明的优选实施方式，应当指出，对于本技术领域的普通技术人员来说，在不脱离本发明技术原理的前提下，还可以做出若干改进和变形，这些改进和变形也应视为本发明的保护范围。
